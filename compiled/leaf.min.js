(function(){var Collection,EnhancedWidget,EventEmitter,Key,KeyEventManager,Leaf,List,Model,Mouse,Router,Util,Widget,exports,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};if(!exports){exports=window}Leaf={};exports.Leaf=Leaf;EventEmitter=function(){function EventEmitter(){this._events={};this._bubbles=[];this.trigger=this.emit;this.bind=this.on}EventEmitter.prototype.on=function(event,callback,context){var handler,handlers;handlers=this._events[event]=this._events[event]||[];handler={callback:callback,context:context};handlers.push(handler);return this};EventEmitter.prototype.removeListener=function(event,listener){var handler,handlers,index,_i,_len;handlers=this._events[event];if(!handlers){return this}for(index=_i=0,_len=handlers.length;_i<_len;index=++_i){handler=handlers[index];if(handler.callback===listener){handlers[index]=null}}this._events[event]=handlers.filter(function(item){return item});return this};EventEmitter.prototype.removeAllListeners=function(event){if(event){this._events[event]=[]}else{this._events={}}return this};EventEmitter.prototype.emit=function(){var event,handler,handlers,index,once,params,_i,_len;event=arguments[0],params=2<=arguments.length?__slice.call(arguments,1):[];handlers=this._events[event];if(handlers){once=false;for(index=_i=0,_len=handlers.length;_i<_len;index=++_i){handler=handlers[index];handler.callback.apply(handler.context||this,params);if(handler.once){once=true}}if(once){this._events[event]=handlers.filter(function(item){return item.once!==true})}}return this};EventEmitter.prototype.once=function(event,callback,context){var handler,handlers;handlers=this._events[event]=this._events[event]||[];handler={callback:callback,context:context,once:true};handlers.push(handler);return this};EventEmitter.prototype.bubble=function(emitter,event,processor){var listener;listener=function(_this){return function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];if(processor){args=processor.apply(_this,args)}else{args.unshift(event)}return _this.emit.apply(_this,args)}}(this);emitter.on(event,listener);return this._bubbles.push({emitter:emitter,event:event,listener:listener})};EventEmitter.prototype.stopBubble=function(emitter,event){this._bubbles=this._bubbles.filter(function(item){if(item.emitter===emitter){if(!event||item.event===event){item.emitter.removeListener(item.event,item.listener);return false}}return true});return this};EventEmitter.prototype.stopAllBubble=function(){var item,_i,_len,_ref;_ref=this._bubbles;for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i];item.emitter.removeListener(item.event,item.listener)}this._bubbles=null;return this};EventEmitter.prototype.destroy=function(){this._events=null;this.stopAllBubble();this.isDestroy=true;return null};EventEmitter.prototype.listenBy=function(who,event,callback,context){var handler,handlers;this._events[event]=this._events[event]||[];handlers=this._events[event];handler={callback:callback,context:context,owner:who};handlers.push(handler);return this};EventEmitter.prototype.stopListenBy=function(who){var event,handler,handlers,index,_i,_len;for(event in this._events){handlers=this._events[event];if(!handlers){continue}for(index=_i=0,_len=handlers.length;_i<_len;index=++_i){handler=handlers[index];if(handler.owner===who){handlers[index]=null}}this._events[event]=handlers.filter(function(item){return item});return this}};return EventEmitter}();Leaf.EventEmitter=EventEmitter;Util={};Util.isHTMLElement=function(template){if(typeof HTMLElement==="object"&&template instanceof HTMLElement||template&&typeof template==="object"&&template.nodeType===1&&typeof template.nodeName==="string"){return true}return false};Util.isHTMLNode=function(o){return typeof Node==="object"&&o instanceof Node||o&&typeof o==="object"&&typeof o.nodeType==="number"&&typeof o.nodeName==="string"};Util.isMobile=function(){if(navigator&&navigator.userAgent){return(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))&&true}else{return false}};Util.getBrowserInfo=function(){var M,N,tem,ua;N=navigator.appName;ua=navigator.userAgent;M=ua.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);tem=ua.match(/version\/([\.\d]+)/i);if(M&&tem!==null){M[2]=tem[1]}M=M?[M[1],M[2]]:[N,navigator.appVersion,"-?"];return{name:M[0],version:M[1],mobile:Util.isMobile()}};Util.browser=Util.getBrowserInfo();Util.capitalize=function(string){return string.charAt(0).toUpperCase()+string.slice(1)};Util.clone=function(x){var item,obj,prop,r,_i,_len;if(x===null||x===void 0){return x}if(typeof x.clone==="function"){return x.clone()}if(x.constructor===Array){r=[];for(_i=0,_len=x.length;_i<_len;_i++){item=x[_i];r.push(Util.clone(item))}return r}if(typeof x==="Object"){obj={};for(prop in x){obj[prop]=Util.clone(x[prop]);return obj}}return x};Util.compare=function(x,y){var index,item,p,_i,_j,_len,_len1;if(x===y){return true}if(x instanceof Array&&y instanceof Array){if(x.length!==y.length){return false}for(index=_i=0,_len=x.length;_i<_len;index=++_i){item=x[index];if(!Util.compare(item,y[index])){return false}}return true}for(p in y){if(typeof x[p]==="undefined"){return false}}for(p in y){if(y[p]){switch(typeof y[p]){case"object":if(!Util.compare(y[p],x[p])){return false}break;case"function":if(typeof x[p]==="undefined"||p!=="equals"&&y[p].toString()!==x[p].toString()){return false}break;default:if(y[p]!==x[p]){return false}}}else if(x[p]){return false}}for(_j=0,_len1=x.length;_j<_len1;_j++){p=x[_j];if(typeof y[p]==="undefined"){return false}}return true};Leaf.Util=Util;Leaf.EventEmitter=EventEmitter;KeyEventManager=function(_super){__extends(KeyEventManager,_super);KeyEventManager.stack=[];KeyEventManager.disable=function(){return this.isActive=true};KeyEventManager.enable=function(){return this.isActive=false};KeyEventManager.isActive=true;function KeyEventManager(node){KeyEventManager.__super__.constructor.call(this);KeyEventManager.instances.push(this);this.isActive=false;if(node){this.attachTo(node)}}KeyEventManager.prototype.attachTo=function(node){this.attachment=node;$(this.attachment).keydown(function(_this){return function(e){e.capture=function(){this.catchEvent=false;this.preventDefault();return this.stopImmediatePropagation()};if(_this.isActive&&KeyEventManager.isActive){_this.emit("keydown",e);return e.catchEvent}return e.catchEvent}}(this));return $(this.attachment).keyup(function(_this){return function(e){e.capture=function(){this.catchEvent=false;this.preventDefault();return this.stopImmediatePropagation()};if(_this.isActive&&KeyEventManager.isActive){_this.emit("keyup",e);return e.catchEvent}return e.catchEvent}}(this))};KeyEventManager.prototype.active=function(){return this.isActive=true};KeyEventManager.prototype.deactive=function(){return this.isActive=false};KeyEventManager.prototype.master=function(){if(KeyEventManager.current===this){console.error("already mastered");console.trace();return}this.active();if(KeyEventManager.current){KeyEventManager.current.deactive();KeyEventManager.stack.push(KeyEventManager.current)}return KeyEventManager.current=this};KeyEventManager.prototype.unmaster=function(){var prev;if(KeyEventManager.current!==this){console.error("current input are not in master");console.trace();return}this.deactive();prev=null;if(KeyEventManager.stack.length>0){prev=KeyEventManager.stack.pop();prev.active()}KeyEventManager.current=prev;return KeyEventManager.instances=[]};return KeyEventManager}(EventEmitter);Key={};Key["0"]=48;Key["1"]=49;Key["2"]=50;Key["3"]=51;Key["4"]=52;Key["5"]=53;Key["6"]=54;Key["7"]=55;Key["8"]=56;Key["9"]=57;if(Util.browser){if(Util.browser.name==="firefox"){Key.cmd=224}else if(Util.browser.name==="opera"){Key.cmd=17}else{Key.cmd=91}}else{Key.cmd=91}Key.a=65;Key.b=66;Key.c=67;Key.d=68;Key.e=69;Key.f=70;Key.g=71;Key.h=72;Key.i=73;Key.j=74;Key.k=75;Key.l=76;Key.m=77;Key.n=78;Key.o=79;Key.p=80;Key.q=81;Key.r=82;Key.s=83;Key.t=84;Key.u=85;Key.v=86;Key.w=87;Key.x=88;Key.y=89;Key.z=90;Key.space=32;Key.shift=16;Key.ctrl=17;Key.alt=18;Key.left=37;Key.up=38;Key.right=39;Key.down=40;Key.enter=13;Key.backspace=8;Key.escape=27;Key.del=Key["delete"]=46;Key.esc=27;Key.pageup=33;Key.pagedown=34;Key.tab=9;Mouse={};Mouse.left=0;Mouse.middle=1;Mouse.right=2;Leaf.KeyEventManager=KeyEventManager;Leaf.Key=Key;Leaf.Mouse=Mouse;Model=function(_super){__extends(Model,_super);function Model(){var data;Model.__super__.constructor.call(this);data={};this.__defineGetter__("data",function(_this){return function(){return data}}(this));this.__defineSetter__("data",function(_this){return function(obj){return _this.sets(obj)}}(this));this._defines={};this._idprop=null}Model.prototype.has=function(name){if(this._defines[name]){return true}return false};Model.prototype.declare=function(name){var obj;if(this._defines[name]){throw new Error("already defines model property "+name)}obj={};this._defines[name]=obj;this.data.__defineGetter__(name,function(_this){return function(){return obj.value}}(this));return this.data.__defineSetter__(name,function(_this){return function(value){if(obj.value===value){return value}obj.value=value;_this.emit("change",name,value);_this.emit("change/"+name,value);return value}}(this))};Model.prototype.reset=function(){var prop,_results;_results=[];for(prop in this._defines){_results.push(this.data[prop]=this._defines[prop]["default"])}return _results};Model.prototype.get=function(key,value){var result;if(!this._defines[key]){throw new Error("undefined model property "+key)}result=this.data[key];if(typeof result==="undefined"){return value}else{return result}};Model.prototype.set=function(key,value){if(!this._defines[key]){throw new Error("undefined model property "+key)}return this.data[key]=value};Model.prototype.sets=function(obj){var prop,_results;if(!obj){return}_results=[];for(prop in obj){if(this._defines[prop]){_results.push(this.set(prop,obj[prop]))}else{_results.push(void 0)}}return _results};Model.prototype.destroy=function(){if(this.isDestroy){return}this.isDestroy=true;console.debug(this._events["destroy"]);this.emit("destroy");Model.__super__.destroy.call(this);return this._defines=null};Model.prototype.toJSON=function(){var prop,result;result={};for(prop in this._defines){result[prop]=this.data[prop]}return result};return Model}(EventEmitter);Leaf.Model=Model;Collection=function(_super){__extends(Collection,_super);function Collection(){Collection.__super__.constructor.call(this);this.models=[];this.id=null;this.__defineGetter__("length",function(_this){return function(){return _this.models.length}}(this))}Collection.prototype.exists=function(model){if(this.get(model)){return true}return false};Collection.prototype.setId=function(id){if(this.models.length!==0){throw new Error("set id should before collection has any content")}return this.id=id};Collection.prototype.get=function(model){var target;target=null;this.models.some(function(_this){return function(old){if(_this.id){if(old.get(_this.id)===model.get(_this.id)){target=old;return true}return false}else if(model===old){target=old;return true}return false}}(this));if(target){return target}return null};Collection.prototype.add=function(model){var old;if(!(model instanceof Model)){throw new Error("add invalid model, not instanceof Leaf.Model")}old=this.get(model);if(old){old.sets(model.data);return old}this.models.push(model);this._attachModel(model);this.emit("add",model);return model};Collection.prototype.empty=function(){var model,_i,_len,_ref;_ref=this.models;for(_i=0,_len=_ref.length;_i<_len;_i++){model=_ref[_i];this._detachModel(model);this.emit("remove",model)}return this.models=[]};Collection.prototype.remove=function(model){var target;target=this.get(model);if(!target){return false}this.models=this.models.filter(function(item){return item!==target});this._detachModel(target);this.emit("remove",target);return true};Collection.prototype._attachModel=function(model){model.listenBy(this,"destroy",function(_this){return function(){_this.remove(model);return _this.emit("destroy/model",model)}}(this));return model.listenBy(this,"change",function(_this){return function(key,value){if(_this.id&&key===_this.id){throw new Error("shouldn't change id "+key+" for model inside a the collection")}_this.emit("change/model",model);return _this.emit("change/model/"+key,model,key,value)}}(this))};Collection.prototype._detachModel=function(model){return model.stopListenBy(this)};return Collection}(EventEmitter);Leaf.Collection=Collection;Widget=function(_super){__extends(Widget,_super);function Widget(template){this.template=template!=null?template:"<div></div>";Widget.__super__.constructor.call(this);this.node=null;this.$node=null;this.node$=null;this.nodes=[];this.UI={};this.initTemplate(this.template)}Widget.prototype.initTemplate=function(template){var node,oldNode,query,tempNode,_i,_j,_len,_len1,_ref,_ref1;if(!template){template="<div></div>"}this.nodes=[];oldNode=this.node;if(typeof template==="string"){template=template.trim();if(template.indexOf("<")!==0){query=template;this.node=document.querySelector(query);if(!this.node){console.error("template of query "+query+" not found");return}this.nodes=[this.node];this.node.widget=this}else{tempNode=document.createElement("div");tempNode.innerHTML=template.trim();this.node=tempNode.children[0];_ref=tempNode.children;for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];this.nodes.push(node);node.widget=this}}}else if(Util.isHTMLNode(template)){this.node=template;this.node.widget=this;this.nodes.push(template)}if(!this.node){throw"invalid template "+template}if(typeof $==="function"){this.$node=$(this.node);this.node$=this.$node}if(oldNode&&oldNode.parentElement){_ref1=this.nodes;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){node=_ref1[_j];oldNode.parentElement.insertBefore(node,oldNode)}oldNode.parentElement.removeChild(oldNode)}this.initUI();return this.initSubWidgets()};Widget.prototype.initSubWidgets=function(){var index,item,name,node,widget,widgets,_i,_j,_len,_len1,_ref,_results,_widgets;_ref=this.nodes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];widgets=node.getElementsByTagName("widget");_widgets=[];for(_j=0,_len1=widgets.length;_j<_len1;_j++){item=widgets[_j];_widgets.push(item)}widgets=_widgets;_results.push(function(){var _k,_len2,_results1;_results1=[];for(index=_k=0,_len2=widgets.length;_k<_len2;index=++_k){widget=widgets[index];name=widget.getAttribute("data-widget");if(!name){continue}if(this[name]instanceof Widget){_results1.push(this[name].replace(widget))}else if(this[name]){console.error("Widget named "+name+" isnt isn't instanceof Widget");_results1.push(console.trace())}else{console.error("Widget named",name,"not exists for",widget);_results1.push(console.trace())}}return _results1}.call(this))}return _results};Widget.prototype.initUI=function(){var elems,id,node,subNode,_i,_j,_len,_len1,_ref;if(!this.nodes){throw"invalid root "+this.nodes}_ref=this.nodes;for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];elems=node.querySelectorAll("[data-id]");elems=[].slice.call(elems);elems.unshift(node);for(_j=0,_len1=elems.length;_j<_len1;_j++){subNode=elems[_j];if(subNode.tagName.toLowerCase()==="widget"){continue}if(id=subNode.getAttribute("data-id")){this.UI[id]=subNode;subNode.widget=this;this._delegateEventForControl(id);if(typeof $==="function"){this.UI[id+"$"]=this.UI["$"+id]=$(subNode)}}}}this._delegateEventForControl();return true};Widget.prototype._delegateEventForControl=function(id){var event,events,node,_i,_len,_results;events=["blur","click","focus","keydown","keyup","keypress","mousemove","mouseenter","mouseleave","mouseover","mouseout","scroll"];node=this.UI[id];if(!node){node=this.node;id="node"}_results=[];for(_i=0,_len=events.length;_i<_len;_i++){event=events[_i];_results.push(function(_this){return function(event){return node["on"+event]=function(e){if(typeof _this["on"+Util.capitalize(event)+Util.capitalize(id)]==="function"){return _this["on"+Util.capitalize(event)+Util.capitalize(id)](e)}return true}}}(this)(event))}return _results};Widget.prototype.appendTo=function(target){var node,_i,_j,_len,_len1,_ref,_ref1,_results;if(Util.isHTMLElement(target)){_ref=this.nodes;for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];target.appendChild(node)}return true}if(target instanceof Leaf.Widget){_ref1=this.nodes;_results=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){node=_ref1[_j];_results.push(target.node.appendChild(node))}return _results}};Widget.prototype.replace=function(target){this.before(target);if(target instanceof Leaf.Widget){target.remove();return}if(Util.isHTMLElement(target)&&target.parentElement){target.parentElement.removeChild(target)}};Widget.prototype.prependTo=function(target){var first,node,_i,_j,_len,_len1,_ref,_ref1;if(Util.isHTMLElement(target)){target=target}else if(target instanceof Leaf.Widget){target=target.node}else{return false}if(target.children.length===0){_ref=this.nodes;for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];target.appendChild(node)}}else{this.nodes.reverse();first=target.children[0];_ref1=this.nodes;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){node=_ref1[_j];target.insertBefore(node,first)}this.nodes.reverse()}return true};Widget.prototype.remove=function(){var node,_i,_len,_ref,_results;_ref=this.nodes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];if(node.parentElement){_results.push(node.parentElement.removeChild(node))}else{_results.push(void 0)}}return _results};Widget.prototype.after=function(target){var node,_i,_j,_len,_len1,_ref,_ref1,_results,_results1;if(Util.isHTMLElement(target)){target=target}else if(target instanceof Leaf.Widget){target=target.node}else{console.error("Insert unknow Object",target);return false}if(!target||!target.parentElement){console.log(target,target.parentElement);console.error("can't insert befere root element ");return false}if(target.nextElementSibling){_ref=this.nodes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];_results.push(target.parentElement.insertBefore(node,target.nextElementSibling))}return _results}else{_ref1=this.nodes;_results1=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){node=_ref1[_j];_results1.push(target.parentElement.appendChild(node))}return _results1}};Widget.prototype.before=function(target){var node,_i,_len,_ref;if(Util.isHTMLElement(target)){target=target}else if(target instanceof Leaf.Widget){target=target.node}else{console.error("Insert unknow Object,target");return false}if(!target||!target.parentElement){console.error("can't insert befere root element ");return false}_ref=this.nodes;for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];target.parentElement.insertBefore(node,target)}this.nodes.reverse();return true};Widget.prototype.occupy=function(target){if(Util.isHTMLElement(target)){target.innerHTML=""}if(target instanceof Leaf.Widget){target.node.innerHTML=""}return this.appendTo(target)};Widget.prototype.destroy=function(){if(this.isDestroy){return}this.isDestroy=true;this.emit("destroy");Widget.__super__.destroy.call(this);this.UI=null;this.node=null;this.node$=null;return this.$node=null};return Widget}(Leaf.EventEmitter);List=function(_super){__extends(List,_super);function List(template,create){List.__super__.constructor.call(this,template);this.init(create);Object.defineProperty(this,"length",{get:function(_this){return function(){return _this._length}}(this),set:function(_this){return function(value){var index,item,toRemove,_i,_j,_len,_ref,_results;toRemove=[];if(value>_this._length){throw"can't asign length larger than the origin"}if(value<0){throw"can't asign length lesser than 0"}if(typeof value!=="number"){throw new TypeError}for(index=_i=value,_ref=_this.length;value<=_ref?_i<_ref:_i>_ref;index=value<=_ref?++_i:--_i){toRemove.push(_this[index]);delete _this[index]}_this._length=value;_results=[];for(_j=0,_len=toRemove.length;_j<_len;_j++){item=toRemove[_j];_results.push(_this._detach(item))}return _results}}(this)})}List.prototype.init=function(create){this.create=create||this.create||function(_this){return function(item){return item}}(this);this._length=0;return this.node.innerHTML=""};List.prototype.check=function(item){var child,_i,_len,_results;if(!(item instanceof Widget)){throw"Leaf List only accept widget as element"}_results=[];for(_i=0,_len=this.length;_i<_len;_i++){child=this[_i];if(child===item){throw"already exists"}else{_results.push(void 0)}}return _results};List.prototype.indexOf=function(item){var child,index,_i,_len;for(index=_i=0,_len=this.length;_i<_len;index=++_i){child=this[index];if(item===child){return index}}return-1};List.prototype.push=function(item){item=this.create(item);this.check(item);this[this._length]=item;this._length++;item.appendTo(this.node);item.parentList=this;return this._attach(item)};List.prototype.pop=function(){var item;if(this._length===0){return null}this._length-=1;item=this[this._length];delete this[this._length];this._detach(item);return item};List.prototype.unshift=function(item){var index,_i,_ref;item=this.create(item);this.check(item);if(this._length===0){item.appendTo(this.node);this[0]=item;this._length=1;this._attach(item);return}for(index=_i=_ref=this._length;_ref<=1?_i<=1:_i>=1;index=_ref<=1?++_i:--_i){this[index]=this[index-1]}this[0]=item;this._length+=1;item.prependTo(this.node);this._attach(item);return this._length};List.prototype.removeItem=function(item){var index;index=this.indexOf(item);if(index<0){return index}this.splice(index,1);return item};List.prototype.shift=function(){var index,result,_i,_ref;result=this[0];for(index=_i=0,_ref=this._length-1;0<=_ref?_i<_ref:_i>_ref;index=0<=_ref?++_i:--_i){this[index]=this[index+1]}this._length-=1;this._detach(result);return result};List.prototype.splice=function(){var achor,count,increase,index,item,offset,origin,result,toAdd,toAddFinal,toRemoves,_i,_j,_k,_l,_len,_len1,_len2,_len3,_m,_n,_o,_ref,_ref1,_ref2,_ref3;index=arguments[0],count=arguments[1],toAdd=3<=arguments.length?__slice.call(arguments,2):[];result=[];toRemoves=[];if(typeof count==="undefined"||index+count>this._length){count=this._length-index}for(offset=_i=0;0<=count?_i<count:_i>count;offset=0<=count?++_i:--_i){item=this[index+offset];toRemoves.push(item);result.push(item)}toAddFinal=function(){var _j,_len,_results;_results=[];for(_j=0,_len=toAdd.length;_j<_len;_j++){item=toAdd[_j];_results.push(this.create(item))}return _results}.call(this);if(index===0){for(_j=0,_len=toAddFinal.length;_j<_len;_j++){item=toAddFinal[_j];this.check(item);item.prependTo(this.node);this._attach(item)}}else{achor=this[index-1];for(_k=0,_len1=toAddFinal.length;_k<_len1;_k++){item=toAddFinal[_k];this.check(item);item.after(achor);this._attach(item)}}increase=toAddFinal.length-count;if(increase<0){for(origin=_l=_ref=index+count,_ref1=this._length;_ref<=_ref1?_l<_ref1:_l>_ref1;origin=_ref<=_ref1?++_l:--_l){this[origin+increase]=this[origin]}}else if(increase>0){for(origin=_m=_ref2=this._length-1,_ref3=index+count-1;_ref2<=_ref3?_m<_ref3:_m>_ref3;origin=_ref2<=_ref3?++_m:--_m){this[origin+increase]=this[origin]}}for(offset=_n=0,_len2=toAddFinal.length;_n<_len2;offset=++_n){item=toAddFinal[offset];this[index+offset]=item}this._length+=increase;for(_o=0,_len3=toRemoves.length;_o<_len3;_o++){item=toRemoves[_o];this._detach(item)}return result};List.prototype.slice=function(from,to){return this.toArray().slice(from,to)};List.prototype.forEach=function(handler){var item,_i,_len,_results;_results=[];for(_i=0,_len=this.length;_i<_len;_i++){item=this[_i];_results.push(handler(item))}return _results};List.prototype.toArray=function(){var item;return function(){var _i,_len,_results;_results=[];for(_i=0,_len=this.length;_i<_len;_i++){item=this[_i];_results.push(item)}return _results}.call(this)};List.prototype.syncWith=function(arr,converter){var finalArr,index,item,_,_i,_j,_k,_len,_len1,_ref;if(converter==null){converter=function(item){return item}}finalArr=[];for(index=_i=0,_len=arr.length;_i<_len;index=++_i){item=arr[index];_=converter(item);if(!(_ instanceof Widget)){throw"sync of invalid widget at index:"+index}finalArr.push(_)}for(index=_j=0,_ref=this._length;0<=_ref?_j<_ref:_j>_ref;index=0<=_ref?++_j:--_j){this._detach(this[index]);delete this[index]}this.node.innerHTML="";for(index=_k=0,_len1=finalArr.length;_k<_len1;index=++_k){item=finalArr[index];this[index]=item;item.appendTo(this.node);this._attach(item)}this._length=finalArr.length;return this};List.prototype._attach=function(item){item.parentList=this;return this.emit("child/add",item)};List.prototype._detach=function(item){item.parentList=null;item.remove();return this.emit("child/remove",item)};List.prototype.sort=function(judge){return this.sync(this.toArray().sort(judge))};return List}(Widget);Widget.List=List;Widget.makeList=function(_this){return function(node,create){return new Widget.List(node,create)}}(this);Leaf.Widget=Widget;EnhancedWidget=function(_super){__extends(EnhancedWidget,_super);EnhancedWidget.attrs=["text","html","class","value","attribute"];function EnhancedWidget(template){EnhancedWidget.__super__.constructor.call(this,template);this.__defineGetter__("renderData",function(_this){return function(){if(_this.renderDataModel){return _this.renderDataModel.data}else{return null}}}(this));this.__defineSetter__("renderData",function(_this){return function(value){if(_this.renderDataModel){return _this.renderDataModel.data=value}}}(this))}EnhancedWidget.prototype.initTemplate=function(template){var oldModel;oldModel=this.renderDataModel;this.renderDataModel=new Model;this.renderData=this.renderDataModel.data;EnhancedWidget.__super__.initTemplate.call(this,template);this.initRenderData();if(oldModel){this.renderData=oldModel.data;return oldModel.destroy()}};EnhancedWidget.prototype.initRenderData=function(){var attrs,elem,elems,node,selector,_i,_len,_ref,_results;attrs=EnhancedWidget.attrs;selector=attrs.map(function(item){return"[data-"+item+"]"}).join(",");_ref=this.nodes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];elems=[].slice.call(node.querySelectorAll(selector));elems.push(node);_results.push(function(){var _j,_len1,_results1;_results1=[];for(_j=0,_len1=elems.length;_j<_len1;_j++){elem=elems[_j];_results1.push(this.applyRenderRole(elem))}return _results1}.call(this))}return _results};EnhancedWidget.prototype.applyRenderRole=function(elem){var attr,attrs,info,_i,_len,_results;attrs=EnhancedWidget.attrs;_results=[];for(_i=0,_len=attrs.length;_i<_len;_i++){attr=attrs[_i];if(info=elem.getAttribute("data-"+attr)){_results.push(this["_"+attr+"Role"](elem,info))}else{_results.push(void 0)}}return _results};EnhancedWidget.prototype.removeRenderRole=function(elem){return this.renderDataModel.stopListenBy(elem)};EnhancedWidget.prototype._textRole=function(elem,who){if(!this.renderDataModel.has(who)){this.renderDataModel.declare(who)}return this.renderDataModel.listenBy(elem,"change/"+who,function(_this){return function(value){return elem.textContent=value}}(this))};EnhancedWidget.prototype._htmlRole=function(elem,who){if(!this.renderDataModel.has(who)){this.renderDataModel.declare(who)}return this.renderDataModel.listenBy(elem,"change/"+who,function(_this){return function(value){return elem.innerHTML=value}}(this))};EnhancedWidget.prototype._classRole=function(elem,whos){var oldClass,who,_i,_len,_results;whos=whos.split(",").map(function(item){return item.trim()}).filter(function(item){return item});_results=[];for(_i=0,_len=whos.length;_i<_len;_i++){who=whos[_i];if(!this.renderDataModel.has(who)){this.renderDataModel.declare(who)}oldClass="";_results.push(this.renderDataModel.listenBy(elem,"change/"+who,function(_this){return function(value){if(elem.classList.contains(value)){oldClass=value;return}if(oldClass){elem.classList.remove(oldClass)}elem.classList.add(value);return oldClass=value}}(this)))}return _results};EnhancedWidget.prototype._attributeRole=function(elem,whats){var pair,_i,_len,_results;if(whats==null){whats=""}whats=whats.split(",").map(function(item){return item.trim().split(":")}).filter(function(pair){return pair.length===1||pair.length===2});_results=[];for(_i=0,_len=whats.length;_i<_len;_i++){pair=whats[_i];_results.push(function(_this){return function(pair){var name,who;name=pair[0];who=pair[1]||name;if(!_this.renderDataModel.has(who)){_this.renderDataModel.declare(who)}return _this.renderDataModel.listenBy(elem,"change/"+who,function(value){return elem.setAttribute(name,value)})}}(this)(pair))}return _results};EnhancedWidget.prototype._valueRole=function(elem,who){return this._attributeRole(elem,"value:"+who)};EnhancedWidget.prototype._srcRole=function(elem,who){return this._attributeRole(elem,"src:"+who)};EnhancedWidget.prototype.destroy=function(){this.renderDataModel.destroy();this.renderDataModel=null;this.renderData=null;return EnhancedWidget.__super__.destroy.call(this)};return EnhancedWidget}(Widget);Leaf.Widget=EnhancedWidget;(function(Leaf){var TemplateManager;TemplateManager=function(_super){__extends(TemplateManager,_super);function TemplateManager(){TemplateManager.__super__.constructor.call(this);this.tids=[];this.baseUrl="template/";this.templates={};this.suffix=".html";this.timeout=1e4}TemplateManager.prototype.use=function(){var tids;tids=1<=arguments.length?__slice.call(arguments,0):[];return this.tids.push.apply(this.tids,tids)};TemplateManager.prototype.start=function(){return setTimeout(this._start.bind(this),0)};TemplateManager.prototype._start=function(){var all,remain,remainTemplates,tid,_i,_j,_len,_len1,_ref;all=this._fromDomAll();_ref=this.tids;for(_i=0,_len=_ref.length;_i<_len;_i++){tid=_ref[_i];this.templates[tid]=all[tid]}if(this._isRequirementComplete()){this._ready();return this}remain=this._getNotCompleteRequirements();remainTemplates=this._fromDomForEach(remain);for(_j=0,_len1=remain.length;_j<_len1;_j++){tid=remain[_j];this.templates[tid]=remainTemplates[tid]}if(this._isRequirementComplete()){this._ready();return this}remain=this._getNotCompleteRequirements();return this._fromXHRForEach(remain,function(_this){return function(err,tid,template){if(err!=null){_this.emit("error",err);return}_this.templates[tid]=template;if(_this._isRequirementComplete()){return _this._ready()}}}(this))};TemplateManager.prototype._ready=function(){return this.emit("ready",this.templates)};TemplateManager.prototype._getNotCompleteRequirements=function(){var tid,_i,_len,_ref,_results;_ref=this.tids;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){tid=_ref[_i];if(!this.templates[tid]){_results.push(tid)}}return _results};TemplateManager.prototype._isRequirementComplete=function(){var tid,_i,_len,_ref;_ref=this.tids;for(_i=0,_len=_ref.length;_i<_len;_i++){tid=_ref[_i];if(!this.templates[tid]){return false}}return true};TemplateManager.prototype._fromDomAll=function(){var e;try{return JSON.parse(document.getElementById("leaf-templates").innerHTML)}catch(_error){e=_error;return{}}};TemplateManager.prototype._fromDomForEach=function(tids){var templateNode,templates,tid,_i,_len;templates={};for(_i=0,_len=tids.length;_i<_len;_i++){tid=tids[_i];templateNode=document.getElementById("leaf-templates-"+tid);templates[tid]=templateNode?templateNode.innerHTML:void 0}return templates};TemplateManager.prototype._fromXHRForEach=function(tids,callback){var targetURI,tid,_fn,_i,_len;_fn=function(_this){return function(){var XHR;XHR=new XMLHttpRequest;XHR.open("GET",targetURI,true);XHR.send(null);XHR.tid=tid;XHR.terminator=setTimeout(function(){callback("timeout",XHR.tid,null);
XHR.done=true;return XHR.abort()},_this.timeout);return XHR.onreadystatechange=function(){var _ref;if(this.done){return}if(this.readyState===0){callback(new Error("fail to load template"));return}if(this.readyState===4){this.done=true;if((_ref=this.status)===200||_ref===302||_ref===304){return callback(null,this.tid,this.responseText)}else{return callback(this.status,this.tid,null)}}}}}(this);for(_i=0,_len=tids.length;_i<_len;_i++){tid=tids[_i];if(tid.indexOf(".")>=1){targetURI=this.baseUrl+tid}else{targetURI=this.baseUrl+tid+this.suffix}_fn()}return null};return TemplateManager}(Leaf.EventEmitter);return Leaf.TemplateManager=TemplateManager})(this.Leaf);(function(Leaf){var ApiManager;ApiManager=function(_super){__extends(ApiManager,_super);function ApiManager(apis){this.apis={};this.path="api/";this.suffix="";this.defaultMethod="GET";this.acceptStatus=[200]}ApiManager.prototype.declare=function(){var apis;apis=1<=arguments.length?__slice.call(arguments,0):[];if(apis.length===1&&typeof apis[0]==="string"){this.initApiByText(apis[0])}return this};ApiManager.prototype.initApiByText=function(apiDeclare){var component;component=this._extractApiComponent(apiDeclare);return this[component.name]=this._createApiByComponent(component)};ApiManager.prototype._createApiByComponent=function(component){return function(_this){return function(){var body,callback,hasValue,holderIndex,i,index,lastIndex,params,placeHolder,placeHoldersValue,promise,url,xhr,_i,_index,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3,_ref4;params=1<=arguments.length?__slice.call(arguments,0):[];params=params.map(function(value){if(typeof value==="string"){return encodeURIComponent(value)}return value});placeHoldersValue=[];if(params.length===component.placeHolders.length&&((_ref=typeof params[0])==="undefined"||_ref==="number"||_ref==="string"||params[0]instanceof String)){placeHoldersValue=params}else if(params.length===1){hasValue=false;_ref1=component.placeHolders;for(_i=0,_len=_ref1.length;_i<_len;_i++){placeHolder=_ref1[_i];if(typeof params[0][placeHolder]!=="undefined"){hasValue=true;placeHoldersValue.push(params[0][placeHolder].toString())}else{placeHoldersValue.push("")}}if(!hasValue){throw"invalid Parameter Object sent:"+JSON.stringify(params[0])}}else if(params.length===0){_ref2=component.placeHolders;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){placeHolder=_ref2[_j];placeHoldersValue.push("")}}else{throw"invalid parameters "+params}url=component.url;body=component.body;lastIndex=0;while(true){index=-1;holderIndex=-1;_ref3=component.placeHolders;for(i=_k=0,_len2=_ref3.length;_k<_len2;i=++_k){placeHolder=_ref3[i];_index=url.indexOf("{"+placeHolder+"}",lastIndex);if(_index<index&&_index>=0){index=_index;holderIndex=i}else if(_index<0&&index<0){index=-1}else if(_index<0&&index>=0){index=index}else if(_index>=0&&index<0){index=_index;holderIndex=i}}if(index<0){break}url=url.substring(0,index)+placeHoldersValue[holderIndex]+url.substring(index+2+component.placeHolders[holderIndex].length);lastIndex=index+placeHoldersValue[holderIndex].length}lastIndex=0;while(true){index=-1;holderIndex=-1;_ref4=component.placeHolders;for(i=_l=0,_len3=_ref4.length;_l<_len3;i=++_l){placeHolder=_ref4[i];_index=body.indexOf("{"+placeHolder+"}",lastIndex);if(_index<index&&_index>=0){index=_index;holderIndex=i}else if(_index<0&&index<0){index=-1}else if(_index<0&&index>=0){index=index}else if(_index>=0&&index<0){index=_index;holderIndex=i}}if(index<0){break}body=body.substring(0,index)+placeHoldersValue[holderIndex]+body.substring(index+2+component.placeHolders[holderIndex].length);lastIndex=index+placeHoldersValue[holderIndex].length}lastIndex=0;callback=null;xhr=new XMLHttpRequest;promise={success:function(callback){console.assert(typeof callback==="function");this._success=callback;return this},fail:function(callback){console.assert(typeof callback==="function");this._fail=callback;return this},response:function(callback){console.assert(typeof callback==="function");this._response=callback;return this},timeout:function(count){console.assert(typeof count==="number");this._timeout=count;return this}};xhr.onreadystatechange=function(state){var e,json,_ref5;if(xhr.readyState===4){if(_ref5=xhr.status,__indexOf.call(_this.acceptStatus,_ref5)<0){if(promise._fail){promise._fail({code:xhr.status},null)}if(promise._response){promise._response({error:"Invalid Http Code",code:xhr.status},null)}return}if(xhr.getResponseHeader("content-type")==="text/json"){try{json=JSON.parse(xhr.responseText)}catch(_error){e=_error;if(promise._fail){promise._fail("Broken Json",{responseText:xhr.responseText})}if(promise._response){promise._response(null,{error:"Broken Json",responseText:xhr.responseText})}}json.responseText=xhr.responseText;if(json.state){if(promise._success){promise._success(json.data)}}else{if(promise._fail){promise._fail(json.error||"Unknown Error",json)}}if(promise._response){return promise._response(null,json)}}else{return callback(null,xhr.responseText)}}};xhr.open(component.method,url,true);xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.send(body);return promise}}(this)};ApiManager.prototype._extractApiComponent=function(apiDeclare){var body,bodyMatch,e,flag,flagPos,i,length,method,methodMatch,name,placeHolder,placeHolders,regBody,regMethod,regName,regUrl,string,url,urlMatch,_i,_j,_len,_ref;regName=/^\w*/i;regUrl=/@[\w:?&=\-+\.\/{}]+/i;regMethod=/#[a-z]+/i;regBody=/\$[\w:?&=\-+\.\/{}]+/i;try{name=regName.exec(apiDeclare)[0]}catch(_error){e=_error;throw"Invalid API name"}urlMatch=regUrl.exec(apiDeclare);url=urlMatch?urlMatch[0].substring(1):this.path+name+this.suffix;methodMatch=regMethod.exec(apiDeclare);method=methodMatch?methodMatch[0].substring(1):this.defaultMethod;bodyMatch=regBody.exec(apiDeclare);body=bodyMatch?bodyMatch[0].substring(1):"";placeHolders=[];_ref=[url,body];for(_i=0,_len=_ref.length;_i<_len;_i++){string=_ref[_i];flag=false;flagPos=0;length=string.length;for(i=_j=0;0<=length?_j<=length:_j>=length;i=0<=length?++_j:--_j){if(string[i]==="{"){if(flag===true){throw"invalid {} pair "+apiDeclare}flag=true;flagPos=i}if(string[i]==="}"){if(flag===false){throw"invalid {} pair "+apiDeclare}flag=false;placeHolder=string.substring(flagPos+1,i);if(__indexOf.call(placeHolders,placeHolder)<0){placeHolders.push(placeHolder)}}}if(flag===true){throw"invalid {} pair "+apiDeclare}}return{name:name,url:url,method:method,body:body,placeHolders:placeHolders}};return ApiManager}(Leaf.EventEmitter);return Leaf.ApiManager=ApiManager})(this.Leaf);Leaf=window.Leaf;(function(Leaf){var Api,ApiContext,ApiFactory,Request;ApiFactory=function(_super){__extends(ApiFactory,_super);function ApiFactory(apis){this.apis={};this.path="api/";this.suffix="";this.defaultMethod="GET";this.acceptStatus=[200];this.infos=[]}ApiFactory.prototype.declare=function(name,params,option){var info,method,url;if(option==null){option={}}console.assert(typeof name==="string");url=option.url||""+this.path+name+this.suffix;method=option.method||this.defaultMethod;params=params instanceof Array&&params||[];info={name:name,url:url,method:method,params:params};this.infos.push(info);return this};ApiFactory.prototype.build=function(){var api,info,_i,_len,_ref;api={};_ref=this.infos;for(_i=0,_len=_ref.length;_i<_len;_i++){info=_ref[_i];api[info.name]=new Api(info).toFunction()}return api};return ApiFactory}(Leaf.EventEmitter);Api=function(){function Api(info){this.info=info;this.declares=this.buildDeclares();this.method=this.info.method.toUpperCase();this.name=this.info.name;this.url=this.info.url}Api.prototype.buildDeclares=function(){var declare,declares,param,paramInfo,paramName,shouldBe,_i,_len,_ref;declares=[];_ref=this.info.params;for(_i=0,_len=_ref.length;_i<_len;_i++){param=_ref[_i];paramInfo=param.split(":").filter(function(value){return value});paramName=paramInfo[0];shouldBe=paramInfo[1]||"string";declare={name:paramName,optional:false};if(shouldBe.lastIndexOf("?")===shouldBe.length-1){declare.optional=true}shouldBe=shouldBe.replace(/\?/g,"");if(shouldBe==="string"){declare.format="string"}else if(shouldBe==="number"){declare.format="number"}else if(shouldBe.length===0){declare.format="string"}else{throw new Error("Unknow Format Declaration In API "+this.info.name+":"+shouldBe)}declares.push(declare)}return declares};Api.prototype.checkParam=function(value,declare){var number;if(typeof value!=="number"&&!value){if(declare.optional){return""}else{throw new Error("API:"+this.info.name+"'s parameter:"+declare.name+" is required but given:"+value)}}if(typeof value==="number"&&isNaN(value)){throw new Error("API "+this.info.name+" parameter:"+declare.name+" recieve an NaN")}if(typeof value===declare.format){return value}if(typeof value==="number"&&declare.format==="string"){console.warn("change param"+declare.name+" of API "+this.info.name+" from number to string");return value.toString()}if(typeof value==="string"&&declare==="number"){number=parseFloat(value);if(isNaN(number)){throw new Error("API "+this.info.name+" parameter:"+declare.name+" require an number but given an string")}else{console.warn("change param"+declare.name+" of API "+this.info.name+" from string to number");return value}}};Api.prototype.checkParams=function(params){var declare,index,_i,_j,_len,_len1,_ref,_ref1,_result;if(params.length===1&&typeof params[0]==="object"){params=params[0];_ref=this.declares;for(_i=0,_len=_ref.length;_i<_len;_i++){declare=_ref[_i];params[declare.name]=this.checkParam(params[declare.name],declare)}return params}else{_result={};_ref1=this.declares;for(index=_j=0,_len1=_ref1.length;_j<_len1;index=++_j){declare=_ref1[index];_result[declare.name]=this.checkParam(params[index],declare)}return _result}};Api.prototype.buildRequest=function(paramsDict){var URI,body,key,query,queryArray,value,_ref;queryArray=[];for(key in paramsDict){value=encodeURIComponent(paramsDict[key]);queryArray.push([key,value].join("="))}query=queryArray.join("&");URI="";body="";if((_ref=this.method)==="GET"||_ref==="DELETE"||_ref==="PUT"){URI=""+this.url+"?"+query}else if(this.method==="POST"){URI=this.url;body=query}else{console.warn("Unknow Method "+this.method+",build as if it is GET")}return{URI:URI,body:body,context:new ApiContext,method:this.method}};Api.prototype.invoke=function(){var params,requestInfo;params=1<=arguments.length?__slice.call(arguments,0):[];params=this.checkParams(params);requestInfo=this.buildRequest(params);return new Request(requestInfo).context};Api.prototype.toFunction=function(){return this.invoke.bind(this)};return Api}();Request=function(_super){__extends(Request,_super);function Request(info){var xhr;this.URI=info.URI;this.body=info.body;this.method=info.method;this.context=info.context;this.acceptStatus=[200,302];this.xhr=new XMLHttpRequest;xhr=this.xhr;xhr.open(this.method,this.URI,true);xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.send(this.body);xhr.onreadystatechange=function(_this){return function(state){var json,_ref;if(xhr.readyState!==4){return}if(_ref=xhr.status,__indexOf.call(_this.acceptStatus,_ref)<0){_this.context._fail("Http Error",_this.createStatus());return}if(xhr.getResponseHeader("content-type")==="text/json"||ApiFactory.forceJson){json=_this.json();if(json){if(json.state===true){_this.context._success(json.data)}else if(json.state===false){_this.context._fail(json.error,_this.createStatus())}return _this.context._response(json)}else{return _this.context._fail("Json Parse Error",_this.createStatus())}}else{_this.context._response(_this.text());return true}}}(this)}Request.prototype.text=function(){return this.xhr.responseText};Request.prototype.json=function(){var e,json;try{json=JSON.parse(this.xhr.responseText)}catch(_error){e=_error;return null}return json};Request.prototype.createStatus=function(){return{httpCode:this.xhr.status,text:this.text(),json:this.json()}};return Request}(Leaf.EventEmitter);ApiContext=function(){function ApiContext(){this._response=function(){};this._fail=function(){};this._success=function(){};this._time=-1}ApiContext.prototype.response=function(callback){console.assert(typeof callback==="function");this._response=callback;return this};ApiContext.prototype.fail=function(callback){console.assert(typeof callback==="function");this._fail=callback;return this};ApiContext.prototype.success=function(callback){console.assert(typeof callback==="function");this._success=callback;return this};ApiContext.prototype.timeout=function(time){console.assert(typeof time==="number");this._time=time;return this};return ApiContext}();ApiFactory.forceJson=true;return Leaf.ApiFactory=ApiFactory})(Leaf);Router=function(_super){__extends(Router,_super);function Router(){return}return Router}(EventEmitter)}).call(this);